<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üõí Mobile Billing</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    :root { 
      --primary: #086ef3; --success: #34a853; --danger: #d93025; 
      --bg: #f8f9fa; --card-bg: #ffffff; --text: #202124; --border: #dadce0;
      --table-text: #000000;
    }
    
     [data-theme="dark"] {
      --bg: #121212; --card-bg: #1e1e1e; --text: #e8eaed; --border: #3c4043;
      --table-text: #e8eaed;
    }
     *{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; transition:0.3s; }
    
    .app-container { 
      background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 8px rgba(19, 17, 17, 0.1); 
      max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; padding: 15px;
    }

    .input-group { background: var(--bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border); position: relative; }

    label { font-size: 0.65rem; font-weight: bold; display: block; margin-bottom: 4px; color: var(--primary); text-transform: uppercase; }
    input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin-bottom: 12px; background: var(--card-bg); color: var(--text); }
    
 #suggestions { 
      position: absolute; 
      left: 12px; 
      right: 12px; 
      background: var(--card-bg); 
      border: 1px solid var(--border); 
      max-height: 200px; 
      overflow-y: auto; 
      z-index: 1000; 
      border-radius: 0 0 6px 6px;
      box-shadow: 0 4px 12px rgba(10, 1, 1, 0);
    }
    .suggestion-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
    .unit-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 12px; }

    .unit-btn { padding: 10px 2px; border: 1px solid var(--border); cursor: pointer; background: var(--card-bg); color: var(--text); border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
    .unit-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    .add-btn { background: var(--primary); color: white; width: 100%; padding: 14px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }
    .print-btn { background: var(--success); color: white; width: 100%; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    .bt-btn { background: #0664f1; color: white; width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 8px; }
    
    .top-controls { display: flex; gap: 10px; margin-bottom: 10px; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto 10px auto; }
    .ctrl-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); cursor: pointer; font-size: 0.75rem; }

    /* Thermal Receipt Styling */
    .bill-panel { padding: 10px; background: #fff; color: #010000; border-radius: 0; border: 1px solid #070606; width: 58mm; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th { text-align: left; border-bottom: 1.5px dashed #000000; padding: 6px 2px; font-size: 0.7rem; }
    td { padding: 8px 2px; border-bottom: 1px solid #eee; font-size: 0.8rem; }
    .summary-box { margin-top: 12px; border-top: 1.5px solid var(--table-text); padding-top: 10px; }

    .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.75rem; }

    .grand-total { font-size: 0.80rem; font-weight: bold; text-align: right; margin-top: 8px; border-top: 1px solid var(--table-text); padding-top: 4px; color: var(--primary); }
    .qr-container { display: flex; flex-direction: column; align-items: center; margin-top: 12px; }
    #qrcode { padding: 5px; background: white; border-radius: 4px; }

    .footer-msg { text-align: center; margin-top: 15px; font-weight: bold; font-size: 0.8rem; border-top: 1px dashed #ccc; padding-top: 8px; }
    @media print {
      .no-print { display: none !important; }
      body { padding: 0; background: white; }
      .app-container { box-shadow: none; border: none; width: 100%; padding: 0; }
      .bill-panel { border: none !important; width: 58mm !important; margin: 0; }
      @page { size: 58mm auto; margin: 0; }
    }
  </style>
</head>
<body>

<div class="top-controls no-print">
  <h3 style="margin:0; color:var(--primary)">üõí Mobile Dashboard</h3>
  <button class="ctrl-btn" onclick="toggleTheme()">üåì Theme</button>
</div>

<div class="app-container">
  <div class="entry-panel no-print">
    <div id="sync-status" style="font-size: 11px; margin-bottom: 5px; opacity: 0.7;">üîÑ Syncing Inventory...</div>
    <button class="bt-btn"style="font-size: 11px" id="connectBT" onclick="connectBluetooth()">üîó Connect Thermal Printer (BT)</button>

    <div class="input-group" style="margin-top:10px;">
      <label>Product Name</label>
      <input type="text" id="pSearch" placeholder="Search item..." autocomplete="off">
      <div id="suggestions"></div>

      <div style="display: flex; gap: 10px;">
        <div style="flex: 1.5;">
          <label>MRP (‚Çπ)</label>
          <input type="number" id="pMRP" placeholder="0.00">
        </div>
        <div style="flex: 1;">
          <label>Qty</label>
          <input type="number" id="pQty" value="" step="0.01">
        </div>
      </div>

      <label>Unit</label>
      <div class="unit-selector">
        <button class="unit-btn active" onclick="quickAdd('Kg')">KG</button>
        <button class="unit-btn" onclick="quickAdd('grams')">GM</button>
        <button class="unit-btn" onclick="quickAdd('pcs')">PCS</button>
        <button class="unit-btn" onclick="quickAdd('ltr')">L</button>
      </div>

      <button class="add-btn" onclick="addItem()">+ ADD ITEM</button>
    </div>
    
    <button class="print-btn" onclick="printBill()">üñ®Ô∏è PRINT RECEIPT</button>
  </div>

  <div class="bill-panel" id="printableBill">
    <div style="text-align: center;">
      <strong style="font-size: 1rem;">CHENNA MALLESHWARA PROVISION STORE</strong><br>
      <span style="font-size: 0.7rem;">#4-43,Gandhi Bazaar, Madakasira - 515301,Contact:9441018885</span><br>
      <span style="font-size: 0.7rem; border-top: 1px dashed #000000; display:block; margin-top:5px; padding-top: 1px;">
        <span id="billDate"></span> | #<span id="billNo"></span>
      </span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Items</th>
          <th>Qty</th>
          <th>Price</th>
          <th style="text-align: right;">Total</th>
        </tr>
      </thead>
      <tbody id="billBody"></tbody>
    </table>

    <div class="summary-box">
      <div class="summary-row"><span>Items:</span> <span id="totQty">0</span></div>
      <div class="summary-row"><span>Total:</span> <span id="Total">‚Çπ0.00</span></div>
      <div class="grand-total">Net Payable: ‚Çπ<span id="netPayable">0.00</span></div>

      <div class="qr-container">
        <div id="qrcode"></div>
        <div class="qr-label">Scan to Pay via UPI</div>
      </div>
    </div>

    <div style="text-align: center; font-size: 0.75rem; margin-top: 10px; border-top: 1px dashed #000000; padding-top: 5px;">
      üôè THANK YOU. VISIT AGAIN! üòä
    </div>
  </div>
</div>

<script>
  const UPI_ID = "9441018885@ybl"; 
  const STORE_NAME = "Chenna Malleshwara Store";
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF6tUzPPv0vZI-8ZxzlPMqpAzBZ4QIovDhFDkTrObeCnAQ5uThQTyKT9a8l2la_pWaxEMtuPio0aIR/pub?output=csv';
  
  let inventory = [];
  let itemsInBill = [];
  let selectedUnit = 'Kg';
  let bluetoothDevice, bluetoothCharacteristic;
  let qrcode = new QRCode(document.getElementById("qrcode"), { width: 100, height: 100 });

  document.getElementById('billDate').innerText = new Date().toLocaleDateString();
  document.getElementById('billNo').innerText = localStorage.getItem('lastBillNo') || 1001;

  async function loadInventory() {
    try {
      const res = await fetch(CSV_URL + '&cb=' + Date.now());
      const data = await res.text();
      inventory = data.split(/\r?\n/).slice(1).map(row => {
        const cols = row.split(',');
        return { name: cols[0]?.trim(), price: parseFloat(cols[1]) || 0 };
      }).filter(i => i.name);
      document.getElementById('sync-status').innerText = "‚úÖ " + inventory.length + " Items Online";
    } catch (e) { document.getElementById('sync-status').innerText = "‚ö†Ô∏è Offline Mode"; }
  }
document.getElementById('pSearch').addEventListener('input', (e) => {
    let q = e.target.value.toLowerCase();
    let s = document.getElementById('suggestions');
    s.innerHTML = '';
    if(!q) return;
    inventory.filter(i => i.name.toLowerCase().includes(q)).slice(0,8).forEach(item => {
      let d = document.createElement('div');
      d.className = 'suggestion-item';
      d.innerText = item.name; 
      d.onclick = () => {
        document.getElementById('pSearch').value = item.name;
        s.innerHTML = '';
        document.getElementById('pMRP').focus(); 
      };
      s.appendChild(d);
    });
  });

  document.getElementById('pSearch').addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('pMRP').focus();
    }
  });

  document.getElementById('pMRP').addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('pQty').focus();
    }
  });

  document.getElementById('pQty').addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
        e.preventDefault();
        addItem(); 
    }
  });

  function quickAdd(u) {
    selectedUnit = u;
    addItem(); 
  }

  function addItem() {
    const name = document.getElementById('pSearch').value;
    const mrp = parseFloat(document.getElementById('pMRP').value);
    const qty = parseFloat(document.getElementById('pQty').value);
    if (!name || isNaN(mrp)) return;

    const actualQty = selectedUnit === 'grams' ? qty / 1000 : qty;
    const lineTotal = mrp * actualQty;

    itemsInBill.push({ name, qty, unit: selectedUnit, mrp, lineTotal });
    updateBill();
    
    // Reset fields
    document.getElementById('pSearch').value = "";
    document.getElementById('pMRP').value = "";
    document.getElementById('pQty').value = "1";
    selectedUnit='kg';
    document.getElementById('pSearch').focus();
  }

  function updateBill() {
    const body = document.getElementById('billBody');
    body.innerHTML = "";
    let sub = 0;

    itemsInBill.forEach((item, index) => {
      sub += item.lineTotal;
      body.innerHTML += `<tr><td>${item.name}</td><td>${item.qty}${item.unit}</td><td>${item.mrp}</td><td style="text-align:right">${item.lineTotal.toFixed(2)}</td><td class="no-print"><button onclick="removeItem(${index})" style="cursor:pointer; background:none; border:none; color:var(--danger)">‚úï</button></td></tr>`;
    });

    const net = Math.round(sub);
    document.getElementById('totQty').innerText = itemsInBill.length;
    document.getElementById('Total').innerText = "‚Çπ" + sub.toFixed(2);
    document.getElementById('netPayable').innerText = net.toFixed(2);

    if (net > 0) {
      const upiUrl = `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(STORE_NAME)}&am=${net}&cu=INR`;
      qrcode.clear();
      qrcode.makeCode(upiUrl);
    }
  }

  function removeItem(idx) { itemsInBill.splice(idx, 1); updateBill(); }

  // 1. Bluetooth Printer Connection
  async function connectBluetooth() {
    try {
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }, { namePrefix: 'BT' }, { namePrefix: 'Printer' }],
        optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
      });
      const server = await bluetoothDevice.gatt.connect();
      const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
      const characteristics = await service.getCharacteristics();
      bluetoothCharacteristic = characteristics[0];
      document.getElementById('connectBT').innerText = "‚úÖ Printer Connected";
      document.getElementById('connectBT').style.background = "#34a853";
    } catch (e) {
      alert("Bluetooth Connection Failed: " + e);
    }
  }

  // 2. Standard Print Logic
  function printBill() {
    if(itemsInBill.length === 0) return;
    window.print();
    let nextNo = parseInt(document.getElementById('billNo').innerText) + 1;
    localStorage.setItem('lastBillNo', nextNo);
    setTimeout(() => location.reload(), 1000); 
  }

  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    const target = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', target);
    localStorage.setItem('theme', target);
  }

  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  window.onload = loadInventory;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üõí Mobile Billing</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    :root { 
      --primary: #1a73e8; --success: #34a853; --danger: #d93025; 
      --bg: #f8f9fa; --card-bg: #ffffff; --text: #202124; --border: #dadce0;
      --table-text: #000000;
    }
    
    [data-theme="dark"] {
      --bg: #121212; --card-bg: #1e1e1e; --text: #e8eaed; --border: #3c4043;
      --table-text: #e8eaed;
    }

    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; transition: 0.3s; }
    
    .app-container { 
      background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      max-width: 500px; margin: auto; display: flex; flex-direction: column; gap: 15px; padding: 15px;
    }

    .input-group { background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); position: relative; }

    label { font-size: 0.7rem; font-weight: bold; display: block; margin-bottom: 5px; color: var(--primary); text-transform: uppercase; }

    input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; box-sizing: border-box; margin-bottom: 12px; background: var(--card-bg); color: var(--text); }
    
    #suggestions { 
      position: absolute; width: calc(100% - 30px); background: var(--card-bg); border: 1px solid var(--border); 
      max-height: 200px; overflow-y: auto; z-index: 1000; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .suggestion-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }

    .unit-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
    .unit-btn { padding: 12px 5px; border: 1px solid var(--border); cursor: pointer; background: var(--card-bg); color: var(--text); border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
    .unit-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    .add-btn { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }
    .print-btn { background: var(--success); color: white; width: 100%; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    
    .top-controls { display: flex; gap: 10px; margin-bottom: 10px; justify-content: space-between; align-items: center; }
    .ctrl-btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); cursor: pointer; font-size: 0.8rem; }

    .bill-panel { padding: 15px; background: var(--card-bg); color: var(--table-text); border-radius: 8px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; border-bottom: 2px solid var(--table-text); padding: 8px 4px; font-size: 0.75rem; }
    td { padding: 8px 4px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }

    .summary-box { margin-top: 15px; border-top: 2px solid var(--table-text); padding-top: 10px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
    .grand-total { font-size: 1.5rem; font-weight: bold; text-align: right; margin-top: 10px; border-top: 1px solid var(--table-text); padding-top: 5px; color: var(--primary); }
    
    .qr-container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      text-align: center; 
      margin-top: 15px; 
      width: 100%;
    }
    #qrcode { display: flex; justify-content: center; }
    #qrcode img { border: 4px solid white; }

    .footer-msg { text-align: center; margin-top: 20px; font-weight: bold; font-size: 0.9rem; border-top: 1px dashed var(--table-text); padding-top: 10px; }

    @media print {
      .no-print { display: none !important; }
      body { padding: 0; background: white; }
      .app-container { box-shadow: none; border: none; width: 100%; padding: 0; }
      .bill-panel { border: none; width: 100%; }
      @page { size: auto; margin: 5mm; }
    }
  </style>
</head>
<body>

<div class="top-controls no-print">
  <h3 style="margin:0; color:var(--primary)">üõí Mobile Billing</h3>
  <button class="ctrl-btn" onclick="toggleTheme()">üåì Theme</button>
</div>

<div class="app-container">
  <div class="entry-panel no-print">
    <div id="sync-status" style="font-size: 11px; margin-bottom: 8px; opacity: 0.7;">üîÑ Syncing Inventory...</div>

    <div class="input-group">
      <label>Product Name</label>
      <input type="text" id="pSearch" placeholder="Search item..." autocomplete="off">
      <div id="suggestions"></div>

      <div style="display: flex; gap: 10px;">
        <div style="flex: 1.5;">
          <label>MRP (‚Çπ)</label>
          <input type="number" id="pMRP" placeholder="0.00">
        </div>
        <div style="flex: 1;">
          <label>Qty</label>
          <input type="number" id="pQty" value="" step="0.01">
        </div>
      </div>

      <label>Unit</label>
      <div class="unit-selector">
        <button class="unit-btn" onclick="quickAdd('Kg')">KG</button>
        <button class="unit-btn" onclick="quickAdd('grams')">GM</button>
        <button class="unit-btn" onclick="quickAdd('pcs')">PCS</button>
        <button class="unit-btn" onclick="quickAdd('ltr')">L</button>
      </div>

      <button class="add-btn" onclick="addItem()">+ ADD ITEM</button>
    </div>
    
    <button class="print-btn" onclick="printBill()">üñ®Ô∏è PRINT RECEIPT</button>
  </div>

  <div class="bill-panel" id="printableBill">
    <div style="text-align: center;">
      <h4 style="margin: 0;">CHENNA MALLESHWARA STORE</h4>
      <p style="margin: 2px; font-size: 0.7rem;">#4-43, Madakasira - 515301</p>
      <p style="margin: 2px; font-size: 0.7rem; border-top: 1px dashed var(--table-text); padding-top: 5px;">
        <span id="billDate"></span> | #<span id="billNo"></span>
      </p>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 45%;">Item</th>
          <th>Qty</th>
          <th style="text-align: right;">Total</th>
          <th class="no-print"></th>
        </tr>
      </thead>
      <tbody id="billBody"></tbody>
    </table>

    <div class="summary-box">
      <div class="summary-row"><span>Items:</span> <span id="totQty">0</span></div>
      <div class="summary-row"><span>Total:</span> <span id="totalAmount">‚Çπ0.00</span></div>
      <div class="grand-total">Net Payable: ‚Çπ<span id="netPayable">0.00</span></div>
      
      <div class="qr-container">
        <div id="qrcode"></div>
        <div style="font-size: 9px; margin-top: 5px; font-weight: bold;">SCAN TO PAY VIA UPI</div>
      </div>
    </div>

    <div class="footer-msg">
      üôè THANK YOU. VISIT AGAIN! üòä
    </div>
  </div>
</div>

<script>
  const UPI_ID = "9133003838@ybl"; 
  const STORE_NAME = "Chenna Malleshwara Store";
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF6tUzPPv0vZI-8ZxzlPMqpAzBZ4QIovDhFDkTrObeCnAQ5uThQTyKT9a8l2la_pWaxEMtuPio0aIR/pub?output=csv';
  
  let inventory = [];
  let itemsInBill = [];
  let selectedUnit = 'Kg';
  let qrcode = new QRCode(document.getElementById("qrcode"), { width: 100, height: 100 });

  document.getElementById('billDate').innerText = new Date().toLocaleDateString();
  document.getElementById('billNo').innerText = localStorage.getItem('lastBillNo') || 1001;

  async function loadInventory() {
    try {
      const res = await fetch(CSV_URL + '&cb=' + Date.now());
      const data = await res.text();
      inventory = data.split(/\r?\n/).slice(1).map(row => {
        const cols = row.split(',');
        return { name: cols[0]?.trim(), price: parseFloat(cols[1]) || 0 };
      }).filter(i => i.name);
      document.getElementById('sync-status').innerText = "‚úÖ " + inventory.length + " Items Online";
    } catch (e) { document.getElementById('sync-status').innerText = "‚ö†Ô∏è Offline Mode"; }
  }

  document.getElementById('pSearch').addEventListener('input', (e) => {
    let q = e.target.value.toLowerCase();
    let s = document.getElementById('suggestions');
    s.innerHTML = '';
    if(!q) return;
    inventory.filter(i => i.name.toLowerCase().includes(q)).slice(0,5).forEach(item => {
      let d = document.createElement('div');
      d.className = 'suggestion-item';
      d.innerText = item.name; 
      d.onclick = () => {
        document.getElementById('pSearch').value = item.name;
        s.innerHTML = '';
        document.getElementById('pMRP').focus();
      };
      s.appendChild(d);
    });
  });

  function quickAdd(u) {
    selectedUnit = u;
    addItem();
  }

  function addItem() {
    const name = document.getElementById('pSearch').value;
    const mrp = parseFloat(document.getElementById('pMRP').value);
    const qty = parseFloat(document.getElementById('pQty').value);
    if (!name || isNaN(mrp)) return;

    const actualQty = selectedUnit === 'grams' ? qty / 1000 : qty;
    const lineTotal = mrp * actualQty;

    itemsInBill.push({ name, qty, unit: selectedUnit, mrp, lineTotal });
    updateBill();
    
    document.getElementById('pSearch').value = "";
    document.getElementById('pMRP').value = "";
    document.getElementById('pQty').value = "1";
    document.getElementById('pSearch').focus();
  }

  function updateBill() {
    const body = document.getElementById('billBody');
    body.innerHTML = "";
    let sub = 0;

    itemsInBill.forEach((item, index) => {
      sub += item.lineTotal;
      body.innerHTML += `<tr>
        <td>${item.name}</td>
        <td>${item.qty}${item.unit}</td>
        <td style="text-align:right">${item.lineTotal.toFixed(2)}</td>
        <td class="no-print"><button onclick="removeItem(${index})" style="color:var(--danger); border:none; background:none; font-size:1.2rem">√ó</button></td>
      </tr>`;
    });

    const net = Math.round(sub);
    document.getElementById('totQty').innerText = itemsInBill.length;
    document.getElementById('totalAmount').innerText = "‚Çπ" + sub.toFixed(2);
    document.getElementById('netPayable').innerText = net.toFixed(2);

    if (net > 0) {
      const upiUrl = `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(STORE_NAME)}&am=${net}&cu=INR`;
      qrcode.clear();
      qrcode.makeCode(upiUrl);
    }
  }

  function removeItem(idx) { itemsInBill.splice(idx, 1); updateBill(); }

  function printBill() {
    if(itemsInBill.length === 0) return;
    window.print();
    let nextNo = parseInt(document.getElementById('billNo').innerText) + 1;
    localStorage.setItem('lastBillNo', nextNo);
    location.reload(); 
  }

  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    const target = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', target);
    localStorage.setItem('theme', target);
  }

  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);

  window.onload = loadInventory;
</script>
</body>
</html>
